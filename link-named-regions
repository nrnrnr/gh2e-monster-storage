#!/bin/ksh

# Create symbolic links to region PNGs with descriptive names
# Usage: link-named-regions labels.txt

if [[ $# -ne 1 ]]; then
    print "Usage: link-named-regions labels.txt" >&2
    exit 1
fi

labels_file="$1"

if [[ ! -f "$labels_file" ]]; then
    print "Error: labels file $labels_file not found" >&2
    exit 1
fi

# Create named subdirectory if it doesn't exist
if [[ ! -d "named" ]]; then
    mkdir -p named
    print "Created directory: named" >&2
fi

# Process each line in labels.txt
while read line; do
    # Skip empty lines and comments
    if [[ -z "$line" || "$line" =~ ^# ]]; then
        continue
    fi
    
    # Extract region ID and name
    region_id=$(echo "$line" | awk '{print $1}')
    name=$(echo "$line" | cut -d' ' -f2-)
    
    if [[ -z "$region_id" || -z "$name" ]]; then
        print "Warning: skipping malformed line: $line" >&2
        continue
    fi
    
    # Construct source and target paths
    source_png="build/region${region_id}.png"
    target_png="named/${name}.png"
    source_tex="build/region${region_id}.tex"
    target_tex="named/${name}.tex"
    
    # Check if source PNG exists
    if [[ ! -f "$source_png" ]]; then
        print "Warning: source file $source_png not found, skipping $region_id" >&2
        continue
    fi
    
    # Remove existing PNG link if it exists
    if [[ -L "$target_png" ]]; then
        rm "$target_png"
    elif [[ -f "$target_png" ]]; then
        print "Warning: $target_png exists and is not a symbolic link, skipping" >&2
        continue
    fi
    
    # Remove existing TEX link if it exists
    if [[ -L "$target_tex" ]]; then
        rm "$target_tex"
    elif [[ -f "$target_tex" ]]; then
        print "Warning: $target_tex exists and is not a symbolic link, skipping" >&2
        continue
    fi
    
    # Create PNG symbolic link with relative path
    ln -s "../$source_png" "$target_png"
    
    if [[ $? -eq 0 ]]; then
        print "Created link: $target_png -> ../$source_png" >&2
    else
        print "Error: failed to create PNG link for $region_id ($name)" >&2
    fi
    
    # Create TEX symbolic link if source exists
    if [[ -f "$source_tex" ]]; then
        ln -s "../$source_tex" "$target_tex"
        
        if [[ $? -eq 0 ]]; then
            print "Created link: $target_tex -> ../$source_tex" >&2
        else
            print "Error: failed to create TEX link for $region_id ($name)" >&2
        fi
    else
        print "Warning: source file $source_tex not found for $region_id" >&2
    fi
    
done < "$labels_file"

print "Finished processing labels file" >&2