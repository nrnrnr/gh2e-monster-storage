#!/bin/ksh

# Add region numbers to original photo
# Usage: number-regions regions.txt original.jpg [output.jpg]
# If output.jpg not specified, writes to build/ directory

if [[ $# -lt 2 || $# -gt 3 ]]; then
    print "Usage: number-regions regions.txt original.jpg [output.jpg]" >&2
    exit 1
fi

regions_file="$1"
original_image="$2"

if [[ $# -eq 3 ]]; then
    output_image="$3"
else
    # Default output to build directory
    basename_orig=$(basename "$original_image" .jpg)
    output_image="build/${basename_orig}-numbered.jpg"
fi

if [[ ! -f "$regions_file" ]]; then
    print "Error: regions file $regions_file not found" >&2
    exit 1
fi

if [[ ! -f "$original_image" ]]; then
    print "Error: original image $original_image not found" >&2
    exit 1
fi

# Build ImageMagick command with all annotations
annotations=""

# Read each region and collect annotations
while read line; do
    # Evaluate the line to set variables
    eval "$line"
    
    if [[ -n "$name" && -n "$centerx" && -n "$centery" && -n "$left" && -n "$top" && -n "$right" && -n "$bottom" ]]; then
        # Adjust center position to account for text size (rough centering)
        adj_x=$((centerx - 50))
        adj_y=$((centery + 70))
        
        # Add bounding box rectangle
        annotations="$annotations -stroke red -strokewidth 2 -fill none -draw \"rectangle $left,$top $right,$bottom\""
        
        # Add region number text
        annotations="$annotations -font Arial-Bold -pointsize 240 -fill white -gravity northwest -annotate +${adj_x}+${adj_y} \"$name\""
    fi
done < "$regions_file"

# Apply all annotations in one command
eval "convert \"$original_image\" $annotations \"$output_image\""
chmod +w "$output_image"

if [[ $? -ne 0 ]]; then
    print "Error: failed to create numbered image" >&2
    exit 1
fi

print "Created numbered image: $output_image" >&2
